var app=angular.module("oauth",["oauth.directive","oauth.accessToken","oauth.endpoint","oauth.profile","oauth.interceptor"]);angular.module("oauth").config(["$locationProvider","$httpProvider",function(e,t){t.interceptors.push("ExpiredInterceptor")}]);var accessTokenService=angular.module("oauth.accessToken",["ngStorage"]);accessTokenService.factory("AccessToken",function(e,t,n,r){var i={token:null},s=["access_token","token_type","expires_in","scope","state","error","error_description"];i.get=function(){return this.token},i.set=function(){return this.setTokenFromString(t.hash()),null===i.token&&o(),this.token},i.destroy=function(){return delete n.token,this.token=null,this.token},i.expired=function(){return this.token&&this.token.expires_at&&this.token.expires_at<new Date},i.setTokenFromString=function(t){var n=a(t);n&&(h(),u(n),l(),e.$broadcast("oauth:login",i.token))};var o=function(){if(n.token){var e=n.token;e.expires_at=new Date(e.expires_at),u(e)}},u=function(e){return i.token=i.token||{},angular.extend(i.token,e),f(),c(),i.token},a=function(e){var t={},n=/([^&=]+)=([^&]*)/g,r;while(r=n.exec(e))t[decodeURIComponent(r[1])]=decodeURIComponent(r[2]);if(t.access_token||t.error)return t},f=function(){n.token=i.token},l=function(){if(i.token){var e=new Date;e.setSeconds(e.getSeconds()+parseInt(i.token.expires_in)-60),i.token.expires_at=e}},c=function(){var t=new Date(i.token.expires_at)-new Date;t&&r(function(){e.$broadcast("oauth:expired",i.token)},t,1)},h=function(){var e=t.hash();angular.forEach(s,function(t){var n=new RegExp("&"+t+"(=[^&]*)?|^"+t+"(=[^&]*)?&?");e=e.replace(n,"")}),t.hash(e)};return i});var endpointClient=angular.module("oauth.endpoint",[]);endpointClient.factory("Endpoint",function(e,t){var n={},r;return n.set=function(e){var t=e.scope?e.scope:"",n=e.state?encodeURIComponent(e.state):"",i=e.authorizePath.indexOf("?")==-1?!1:!0,s=i?"&":"?";return r=e.site+e.authorizePath+s+"response_type="+e.responseType+"&"+"client_id="+encodeURIComponent(e.clientId)+"&"+"redirect_uri="+encodeURIComponent(e.redirectUri)+"&"+"scope="+t+"&"+"state="+n,r},n.get=function(){return r},n.redirect=function(){window.location.replace(r)},n});var profileClient=angular.module("oauth.profile",[]);profileClient.factory("Profile",function(e,t,n){var r={},i;r.find=function(t){var r=e.get(t,{headers:s()});return r.success(function(e){i=e,n.$broadcast("oauth:profile",i)}),r},r.get=function(e){return i},r.set=function(e){return i=e,i};var s=function(){return{Authorization:"Bearer "+t.get().access_token}};return r});var interceptorService=angular.module("oauth.interceptor",[]);interceptorService.factory("ExpiredInterceptor",function(e,t,n){var r={};r.request=function(t){var r=n.token;return r&&i(r)&&e.$broadcast("oauth:expired",r),t};var i=function(e){return e&&e.expires_at&&new Date(e.expires_at)<new Date};return r});var directives=angular.module("oauth.directive",[]);directives.directive("oauth",function(e,t,n,r,i,s,o,u){var a={restrict:"AE",replace:!0,scope:{site:"@",clientId:"@",redirectUri:"@",responseType:"@",scope:"@",profileUri:"@",template:"@",text:"@",authorizePath:"@",state:"@"}};return a.link=function(a,f,l){a.show="none",a.$watch("clientId",function(e){c()});var c=function(){h(),p(),t.set(a),e.set(a),d(a),v()},h=function(){a.authorizePath=a.authorizePath||"/oauth/authorize",a.tokenPath=a.tokenPath||"/oauth/token",a.template=a.template||"bower_components/oauth-ng/dist/views/templates/default.html",a.responseType=a.responseType||"token",a.text=a.text||"Sign In",a.state=a.state||undefined,a.scope=a.scope||undefined},p=function(){o.get(a.template,{cache:u}).success(function(e){f.html(e),s(f.contents())(a)})},d=function(t){var r=e.get();r&&r.access_token&&t.profileUri&&n.find(t.profileUri).success(function(e){t.profile=e})},v=function(){var t=e.get();if(!t)return g();if(t.access_token)return m();if(t.error)return y()};a.login=function(){t.redirect()},a.logout=function(){e.destroy(a),i.$broadcast("oauth:logout"),g()},a.$on("oauth:expired",function(){e.destroy(a),a.show="logged-out"});var m=function(){i.$broadcast("oauth:authorized",e.get()),a.show="logged-in"},g=function(){i.$broadcast("oauth:loggedOut"),a.show="logged-out"},y=function(){a.show="denied",i.$broadcast("oauth:denied")};a.$on("oauth:template:update",function(e,t){a.template=t,p(a)}),a.$on("$routeChangeSuccess",function(){c()})},a}),define("oauth-ng",function(){}),define("px-oauth-directive",["angular","./module","oauth-ng"],function(e,t){return t.directive("pxOauth",function(){return{scope:{site:"=",clientId:"=",redirectUri:"="},restrict:"AE",template:"<oauth ng-hide='true' site='{{site}}' client-id='{{clientId}}' redirect-uri='{{redirectUri}}'></oauth>"}}),t}),define("main",["./module","./px-oauth-directive"],function(){});